#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

# Trap handler for abnormal exit
function on_error {
  local exit_code=$?
  echo "" >&2
  echo "ERROR: forge command failed with exit code $exit_code" >&2
  echo "Command: $basename $*" >&2
  exit $exit_code
}

trap 'on_error "$@"' ERR

# Require BASH >= 4
if [ "${BASH_VERSINFO:-0}" -lt 4 ]; then
  # Try to re-exec with a newer Bash if available (Homebrew/MacPorts) when current Bash < 4
  for candidate in /opt/homebrew/bin/bash /usr/local/bin/bash /opt/local/bin/bash; do
    if [ -x "$candidate" ] && [ "$candidate" != "${BASH:-}" ]; then
      # shellcheck disable=SC2016
      if "$candidate" -c '[[ ${BASH_VERSINFO[0]} -ge 4 ]]'; then
        exec "$candidate" "$0" "$@"
      fi
    fi
  done
  # shellcheck disable=SC2128
  echo "ERROR: Incompatible Bash detected: ${BASH:-} ${BASH_VERSINFO:-} ${BASH_VERSION:-}"
  exit 2
fi

declare -g basename
basename=$(basename "$0")

declare -g basedir
basedir=$(cd "$(dirname "$0")" && pwd)

declare -g forgedir
forgedir="$basedir/.forge"

declare -g command_default
command_default=""

# show message and exit
function die {
  echo "$1"
  exit 1
}

# show usage and exit
function usage {
  set +o nounset
  local syntax="$1"
  set -o nounset

  if [[ -z "$syntax" ]]; then
    echo "usage: $basename <command> [options]"
  else
    echo "usage: $basename $syntax"
  fi
  exit 2
}

# run self
function self {
  $0 "$@"
}

# log debug message to stderr
function log_debug {
  echo "[DEBUG] > $@" >&2
}

declare -A state
declare -g state_file="$forgedir/state.bash"

function write_state() {
  echo "# $(date)" > "$state_file"
  for key in "${!state[@]}"; do
    echo "$key=${state[$key]}" >> "$state_file"
  done
}

function read_state() {
  if [[ -e "$state_file" ]]; then
    while IFS='=' read -r key value; do
       # Skip lines that are comments or empty
      [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
      state["$key"]="$value"
    done < "$state_file"
  fi
}

function main {
  forge_config="$forgedir/config.bash"
  source "$forge_config"

  forge_local_config="$forgedir/local.bash"
  if [[ -f "$forge_local_config" ]]; then
    source "$forge_local_config"
  fi

  set +o nounset
  command="$1"
  set -o nounset

  set +o errexit
  shift
  set -o errexit

  if [[ -z "$command" ]]; then
    if [[ -n "$command_default" ]]; then
      self "$command_default"
    else
      # complain if no command is given
      usage
    fi
  fi

  # attempt to lookup command function
  local fn="command_$command"
  if [[ "$(type -t $fn)" = 'function' ]]; then
    read_state
    $fn "$@"
  else
    # complain about missing command function
    echo "Unknown command: $command"
    usage
  fi
}

main "$@"
